#!/usr/bin/env bash
# chk â€” small, extensible repo checker
set -euo pipefail

PROG="chk"
VERSION="0.2.0"

usage() {
  cat <<'EOF'
chk â€” small, extensible repo checker

Usage:
  chk [options]

Options:
  -h, --help     Show this help and exit
  -q, --quiet    Only print failures + summary
  --version      Print version and exit

Behavior:
  - Checks are only run when applicable
  - Missing optional files (e.g. justfile) do NOT fail
  - Exit code is non-zero only if an applicable check fails

Current checks:
  - If a justfile exists:
      - it must define tasks: dev, format

Exit codes:
  0  all applicable checks passed
  1  one or more applicable checks failed
  2  usage / argument error
EOF
}

QUIET=0

# --- arg parsing
while (($# > 0)); do
  case "$1" in
  -h | --help)
    usage
    exit 0
    ;;
  -q | --quiet)
    QUIET=1
    shift
    ;;
  --version)
    echo "$PROG $VERSION"
    exit 0
    ;;
  *)
    echo "chk: unknown option: $1" >&2
    echo "Try: chk --help" >&2
    exit 2
    ;;
  esac
done

# --- reporting
PASS=0
FAIL=0
SKIP=0
TOTAL=0
REPORT=()

_emit() { REPORT+=("$1 $2"); }
_ok() {
  ((PASS++))
  ((TOTAL++))
  _emit "âœ…" "$1"
}
_fail() {
  ((FAIL++))
  ((TOTAL++))
  _emit "âŒ" "$1"
}
_skip() {
  ((SKIP++))
  ((TOTAL++))
  _emit "â­ï¸" "$1"
}

run_check() { # label command...
  local label="$1"
  shift
  if "$@"; then
    _ok "$label"
  else
    _fail "$label"
  fi
}

# --- helpers
has_justfile() { [[ -f justfile ]]; }

justfile_has_task() {
  local task="$1"
  grep -Eq "^[[:space:]]*${task}([[:space:]]|:)" justfile
}

# --- run
#echo "ðŸ”Ž $PROG: running in $(pwd)"

# ---- Justfile checks (conditional)
if has_justfile; then
  run_check "justfile has task: dev" justfile_has_task dev
  run_check "justfile has task: format" justfile_has_task format
else
  _skip "justfile checks (no justfile present)"
fi

# --- report
if ((QUIET == 0)); then
  echo "chk results:"
  for line in "${REPORT[@]}"; do
    echo "  $line"
  done
else
  echo "chk results (failures only):"
  for line in "${REPORT[@]}"; do
    [[ "$line" == "âŒ "* ]] && echo "  $line"
  done
fi

echo
echo "Summary: âœ… $PASS passed, âŒ $FAIL failed, â­ï¸ $SKIP skipped (total: $TOTAL)"

if ((FAIL > 0)); then
  exit 1
fi
exit 0
