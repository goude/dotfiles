#!/usr/bin/env bash
# Copy to clipboard â€” Wayland, macOS, X11, WSL, etc.

set -euo pipefail
log() { echo "[copyclip] $*" >&2; }

# Environment detection
is_wayland() { [[ -n "${WAYLAND_DISPLAY:-}" && -S "/run/user/$(id -u)/${WAYLAND_DISPLAY}" ]]; }
is_x11() { [[ -n "${DISPLAY:-}" ]]; }

# Ordered list of candidates
CLIP_CMDS=(
  wl-copy
  pbcopy
  clip.exe
  xclip
  xsel
  termux-clipboard-set
  putclip
)

find_clip_cmd() {
  for cmd in "${CLIP_CMDS[@]}"; do
    command -v "$cmd" >/dev/null 2>&1 || continue

    case "$cmd" in
    wl-copy) is_wayland || continue ;;
    xclip | xsel) is_x11 || continue ;;
    esac

    echo "$cmd"
    return 0
  done
  return 1
}

main() {
  if ! clip_cmd=$(find_clip_cmd); then
    log "Error: no working clipboard utility found (checked: ${CLIP_CMDS[*]})"
    exit 1
  fi

  log "Using clipboard command: $clip_cmd"

  case "$clip_cmd" in
  wl-copy | pbcopy | clip.exe | termux-clipboard-set | putclip)
    "$clip_cmd" "$@"
    ;;
  xclip)
    "$clip_cmd" -selection clipboard "$@"
    ;;
  xsel)
    "$clip_cmd" --clipboard --input "$@"
    ;;
  esac
}

main "$@"
