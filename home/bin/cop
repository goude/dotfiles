#!/usr/bin/env bash
# Clipboard helper: copy (default), paste (-p), optional kvdb sync (-n) and encryption (-e).

set -euo pipefail

COP_CMD="${COP_CMD:-pbcopy}"

# kvdb.io bucket id; this is just an opaque identifier, not a privileged secret.
KVDB_BUCKET="B2XJb9EbsXQkxxhvgZmaSp"

GREEN=$'\033[32m'
CYAN=$'\033[36m'
YELLOW=$'\033[33m'
RED=$'\033[31m'
BOLD=$'\033[1m'
RESET=$'\033[0m'

mode=""
bytes=0
LAST_PAYLOAD=""
PASTE_USED=""

log() {
  printf "ðŸ“‹ %s[cop]%s %s\n" "$BOLD$RED" "$RESET" "$*" >&2
}

show_usage() {
  cat >&2 <<EOF

ðŸ“‹ ${BOLD}${GREEN}cop${RESET} ${CYAN}(clipboard helper)${RESET}
   Copy to or paste from the system clipboard, with optional kvdb sync and encryption.

   ${YELLOW}Usage:${RESET}
     Copy (default):
       some_command | cop
       cop < file.txt
       cop file1.txt [file2.txt ...]

     Paste from clipboard:
       cop -p

     Network sync via kvdb.io (bucket fixed in script):
       Copy + sync:
         cop -n            # from stdin
         cop -n file.txt
       Paste from kvdb (key "cop"):
         cop -p -n

     Encryption (local and/or kvdb) using openssl and COP_SECRET:
       Copy encrypted:
         cop -e            # stdin -> encrypted in clipboard (and kvdb if -n)
       Paste encrypted:
         cop -p -e         # clipboard/kvdb -> decrypted to stdout

   Mode is auto-detected for copy based on stdin and arguments.
EOF
}

copy_from_stdin() {
  mode="stdin"
  local data
  data="$(cat)"
  bytes=$(printf "%s" "$data" | wc -c | tr -d ' ')
  LAST_PAYLOAD="$data"
}

copy_from_files() {
  mode="files"
  local data
  data="$(cat -- "$@")"
  bytes=$(printf "%s" "$data" | wc -c | tr -d ' ')
  LAST_PAYLOAD="$data"
}

is_wayland() { [[ -n "${WAYLAND_DISPLAY:-}" && -S "/run/user/$(id -u)/${WAYLAND_DISPLAY}" ]]; }
is_x11() { [[ -n "${DISPLAY:-}" ]]; }

PASTE_CMDS=(
  wl-paste
  pbpaste
  powershell.exe
  xclip
  xsel
  termux-clipboard-get
  getclip
)

find_paste_cmd() {
  for cmd in "${PASTE_CMDS[@]}"; do
    command -v "$cmd" >/dev/null 2>&1 || continue
    case "$cmd" in
    wl-paste) is_wayland || continue ;;
    xclip | xsel) is_x11 || continue ;;
    esac
    echo "$cmd"
    return 0
  done
  return 1
}

get_local_clipboard() {
  local paste_cmd data
  if ! paste_cmd=$(find_paste_cmd); then
    log "Error: no working paste utility found (checked: ${PASTE_CMDS[*]})"
    exit 1
  fi
  PASTE_USED="$paste_cmd"
  case "$paste_cmd" in
  wl-paste | pbpaste | termux-clipboard-get | getclip)
    data="$("$paste_cmd")"
    ;;
  powershell.exe)
    data="$("$paste_cmd" -Command "Get-Clipboard")"
    ;;
  xclip)
    data="$("$paste_cmd" -selection clipboard -o)"
    ;;
  xsel)
    data="$("$paste_cmd" --clipboard --output)"
    ;;
  esac
  printf "%s" "$data"
}

send_to_kvdb() {
  local data=$1
  curl -fsS -X POST -d "$data" "https://kvdb.io/${KVDB_BUCKET}/cop" >/dev/null || {
    log "Failed to sync to kvdb.io bucket '${KVDB_BUCKET}'"
    return 1
  }
  printf "ðŸ“‹ ${BOLD}${GREEN}Synced${RESET} to ${CYAN}kvdb.io${RESET} (bucket: %s, key: cop).\n" \
    "$KVDB_BUCKET" >&2
}

fetch_from_kvdb() {
  curl -fsS "https://kvdb.io/${KVDB_BUCKET}/cop"
}

ensure_crypto() {
  if ! command -v openssl >/dev/null 2>&1; then
    log "Error: openssl not found; -e cannot be used on this system"
    exit 1
  fi
  if [[ -z "${COP_SECRET:-}" ]]; then
    log "Error: COP_SECRET not set; -e requires a symmetric secret in COP_SECRET"
    exit 1
  fi
}

encrypt_data() {
  ensure_crypto
  # stdin -> base64-encoded AES-256-CBC ciphertext
  openssl enc -aes-256-cbc -salt -pass env:COP_SECRET -base64
}

decrypt_data() {
  ensure_crypto
  # stdin (base64 ciphertext) -> plaintext
  openssl enc -d -aes-256-cbc -salt -pass env:COP_SECRET -base64
}

paste_clipboard() {
  local use_network=$1
  local encrypt=$2
  local raw out

  if ((use_network)); then
    raw="$(fetch_from_kvdb)"
    # Mirror the kvdb content into local clipboard (raw, possibly ciphertext).
    if command -v "$COP_CMD" >/dev/null 2>&1; then
      printf "%s" "$raw" | "$COP_CMD" || true
    fi
    printf "ðŸ“‹ ${BOLD}${GREEN}Pasted${RESET} from ${CYAN}kvdb.io${RESET} (bucket: %s, key: cop).\n" \
      "$KVDB_BUCKET" >&2
  else
    raw="$(get_local_clipboard)"
    printf "ðŸ“‹ ${BOLD}${GREEN}Pasted${RESET} from ${CYAN}clipboard${RESET} via ${CYAN}%s${RESET}.\n" \
      "$PASTE_USED" >&2
  fi

  if ((encrypt)); then
    out="$(printf "%s" "$raw" | decrypt_data)"
  else
    out="$raw"
  fi

  printf "%s" "$out"
}

main() {
  local paste=0
  local network=0
  local encrypt=0

  # If invoked as "pas" (symlink), behave as if "-p" was passed.
  local script_name
  script_name=$(basename "$0")
  if [[ "$script_name" == "pas" ]]; then
    set -- -p "$@"
  fi

  # Parse options
  while [[ $# -gt 0 ]]; do
    case "$1" in
    -h | --help)
      show_usage
      exit 0
      ;;
    -p)
      paste=1
      shift
      ;;
    -n)
      network=1
      shift
      ;;
    -e)
      encrypt=1
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      log "Unknown option: $1"
      show_usage
      exit 1
      ;;
    *)
      break
      ;;
    esac
  done

  if ((paste)); then
    paste_clipboard "$network" "$encrypt"
    exit 0
  fi

  # Copy mode: fill LAST_PAYLOAD
  if ! [ -t 0 ]; then
    copy_from_stdin
  elif [ "$#" -gt 0 ]; then
    copy_from_files "$@"
  else
    show_usage
    exit 1
  fi

  local payload="$LAST_PAYLOAD"

  if ((encrypt)); then
    payload="$(printf "%s" "$payload" | encrypt_data)"
  fi

  printf "%s" "$payload" | "$COP_CMD"

  if ((network)); then
    send_to_kvdb "$payload" || true
  fi

  if [ "$mode" = "stdin" ]; then
    printf "ðŸ“‹ ${BOLD}${GREEN}Copied${RESET} from ${CYAN}stdin${RESET} (%s byte(s)).\n" "$bytes"
  else
    printf "ðŸ“‹ ${BOLD}${GREEN}Copied${RESET} from ${CYAN}files${RESET} (%s file(s), %s byte(s)).\n" "$#" "$bytes"
  fi
}

main "$@"
