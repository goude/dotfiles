#!/usr/bin/env bash
# cop â€” clipboard helper with optional network sync and encryption

set -euo pipefail

# --- Configuration -----------------------------------------------------------
KEYVALUE_APP_KEY="pk1vk7oj"
KEYVALUE_KEY="cop"

# --- Pastel Colors (soft, beautiful) -----------------------------------------
C_ROSE=$'\033[38;5;218m'      # soft pink
C_PEACH=$'\033[38;5;223m'     # warm peach  
C_MINT=$'\033[38;5;158m'      # fresh mint
C_SKY=$'\033[38;5;117m'       # morning sky
C_LAVENDER=$'\033[38;5;183m'  # gentle lavender
C_GOLD=$'\033[38;5;222m'      # sunrise gold
C_CORAL=$'\033[38;5;210m'     # soft coral
C_DIM=$'\033[2m'              # dimmed
C_BOLD=$'\033[1m'             # bold
C_RESET=$'\033[0m'            # reset

# --- ASCII Art (configurable: COP_ART_SIZE=small|medium|large) ---------------
COP_ART_SIZE="${COP_ART_SIZE:-medium}"

art_small() {
  cat <<'EOF'
    ___  __  ___
   / __\/ / / _ \
  / /  / /_/ ___/
  \_\  \__/\/    
EOF
}

art_medium() {
  cat <<'EOF'
       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
      â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
      â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
      â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• 
      â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     
       â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•     
EOF
}

art_large() {
  cat <<'EOF'
       â–„â–ˆâ–ˆâ–ˆâ–ˆâ–„   â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆ  
      â–’â–ˆâ–ˆâ–€ â–€â–ˆ  â–’â–ˆâ–ˆâ–’  â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–‘  â–ˆâ–ˆâ–’
      â–’â–“â–ˆ    â–„ â–’â–ˆâ–ˆâ–‘  â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–‘ â–ˆâ–ˆâ–“â–’
      â–’â–“â–“â–„ â–„â–ˆâ–ˆâ–’â–’â–ˆâ–ˆ   â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–„â–ˆâ–“â–’ â–’
      â–’ â–“â–ˆâ–ˆâ–ˆâ–€ â–‘â–‘ â–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–ˆâ–ˆâ–’ â–‘  â–‘
      â–‘ â–‘â–’ â–’  â–‘â–‘ â–’â–‘â–’â–‘â–’â–‘ â–’â–“â–’â–‘ â–‘  â–‘
EOF
}

show_horizon() {
  # Pastel sunrise horizon
  printf "  %s~%s~%s~%s~%s~%s~%s~%s~%s~%s~%s~%s~%s~%s~%s%s\n" \
    "$C_SKY" "$C_MINT" "$C_PEACH" "$C_GOLD" "$C_CORAL" "$C_ROSE" \
    "$C_LAVENDER" "$C_SKY" "$C_MINT" "$C_PEACH" "$C_GOLD" "$C_CORAL" \
    "$C_ROSE" "$C_LAVENDER" "$C_SKY" "$C_RESET"
  
  # Art in gradient colors
  local art_func="art_medium"
  case "$COP_ART_SIZE" in
    small) art_func="art_small" ;;
    large) art_func="art_large" ;;
  esac
  
  local colors=("$C_PEACH" "$C_GOLD" "$C_CORAL" "$C_ROSE" "$C_LAVENDER" "$C_SKY")
  local i=0
  while IFS= read -r line; do
    printf "%s%s%s\n" "${colors[$((i % ${#colors[@]}))]}" "$line" "$C_RESET"
    ((i++)) || true
  done < <($art_func)
  
  # Bottom horizon line  
  printf "  %sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%sâ”%s%s\n" \
    "$C_GOLD" "$C_PEACH" "$C_CORAL" "$C_ROSE" "$C_LAVENDER" \
    "$C_SKY" "$C_MINT" "$C_GOLD" "$C_PEACH" "$C_CORAL" \
    "$C_ROSE" "$C_LAVENDER" "$C_SKY" "$C_MINT" "$C_GOLD" \
    "$C_PEACH" "$C_CORAL" "$C_ROSE" "$C_LAVENDER" "$C_SKY" "$C_RESET"
  printf "  %sâ˜€ clipboard helper%s\n\n" "$C_DIM" "$C_RESET"
}

# --- Logging -----------------------------------------------------------------
log() { printf "ðŸ“‹ %s%s%s\n" "$C_CORAL" "$*" "$C_RESET" >&2; }

# --- Help --------------------------------------------------------------------
show_usage() {
  show_horizon >&2
  cat >&2 <<EOF
${C_GOLD}Usage:${C_RESET}
  cop [OPTIONS] [FILE...]

${C_GOLD}Options:${C_RESET}
  ${C_SKY}-p${C_RESET}  --paste      Paste from clipboard or remote
  ${C_SKY}-n${C_RESET}  --network    Sync via keyvalue.immanuel.co
  ${C_SKY}-e${C_RESET}  --encrypt    AES-256-CBC encrypt/decrypt (\$COP_SECRET)
  ${C_SKY}-c${C_RESET}  --copy       Also copy fetched data locally (with -n)
  ${C_SKY}-i${C_RESET}  --info       Show clipboard command info
  ${C_SKY}-h${C_RESET}  --help       Show this help

${C_GOLD}Examples:${C_RESET}
  ${C_DIM}echo "hello" | cop${C_RESET}      copy text
  ${C_DIM}cop file.txt${C_RESET}            copy file contents
  ${C_DIM}cop -n -e file.txt${C_RESET}      encrypt & sync to remote
  ${C_DIM}cop -p${C_RESET}                  paste from clipboard
  ${C_DIM}cop -pne${C_RESET}                paste, decrypt from remote
  ${C_DIM}cop -p out.txt${C_RESET}          paste into file

${C_DIM}Symlink as 'pas' for paste mode. Options combine: -pne = -p -n -e${C_RESET}
EOF
}

# --- Environment Detection ---------------------------------------------------
is_wayland() { [[ -n "${WAYLAND_DISPLAY:-}" && -S "/run/user/$(id -u)/${WAYLAND_DISPLAY}" ]]; }
is_x11() { [[ -n "${DISPLAY:-}" ]]; }

# --- Copy Command Detection --------------------------------------------------
COPY_CMDS=(wl-copy pbcopy clip.exe xclip xsel termux-clipboard-set putclip)
COPY_USED=""

find_copy_cmd() {
  # Respect explicit override
  [[ -n "${COP_CMD:-}" ]] && command -v "$COP_CMD" &>/dev/null && { echo "$COP_CMD"; return 0; }
  for cmd in "${COPY_CMDS[@]}"; do
    command -v "$cmd" &>/dev/null || continue
    case "$cmd" in
      wl-copy)    is_wayland || continue ;;
      xclip|xsel) is_x11 || continue ;;
    esac
    echo "$cmd"; return 0
  done
  return 1
}

copy_to_clipboard() {
  local cmd
  cmd=$(find_copy_cmd) || { log "No copy utility found"; exit 1; }
  COPY_USED="$cmd"
  case "$cmd" in
    wl-copy|pbcopy|termux-clipboard-set|putclip|clip.exe) "$cmd" ;;
    xclip) "$cmd" -selection clipboard ;;
    xsel)  "$cmd" --clipboard --input ;;
    *)     "$cmd" ;;  # fallback for COP_CMD override
  esac
}

# --- Paste Command Detection -------------------------------------------------
PASTE_CMDS=(wl-paste pbpaste powershell.exe xclip xsel termux-clipboard-get getclip)
PASTE_USED=""

find_paste_cmd() {
  for cmd in "${PASTE_CMDS[@]}"; do
    command -v "$cmd" &>/dev/null || continue
    case "$cmd" in
      wl-paste)   is_wayland || continue ;;
      xclip|xsel) is_x11 || continue ;;
    esac
    echo "$cmd"; return 0
  done
  return 1
}

get_local_clipboard() {
  local cmd
  cmd=$(find_paste_cmd) || { log "No paste utility found"; exit 1; }
  PASTE_USED="$cmd"
  case "$cmd" in
    wl-paste|pbpaste|termux-clipboard-get|getclip) "$cmd" ;;
    powershell.exe) "$cmd" -Command "Get-Clipboard" ;;
    xclip)          "$cmd" -selection clipboard -o ;;
    xsel)           "$cmd" --clipboard --output ;;
  esac
}

# --- Base64 Helpers ----------------------------------------------------------
b64_encode() {
  if base64 --wrap=0 2>/dev/null; then return 0; fi
  if base64 2>/dev/null | tr -d '\n'; then return 0; fi
  python3 -c 'import sys,base64;print(base64.b64encode(sys.stdin.buffer.read()).decode(),end="")' 2>/dev/null || cat
}

b64_decode() {
  local input; input=$(cat)
  base64 --decode 2>/dev/null <<<"$input" && return 0
  base64 -D 2>/dev/null <<<"$input" && return 0
  base64 -d 2>/dev/null <<<"$input" && return 0
  python3 -c 'import sys,base64;sys.stdout.write(base64.b64decode(sys.stdin.read().strip()).decode())' 2>/dev/null <<<"$input" && return 0
  printf "%s" "$input"
}

# --- KeyValue API ------------------------------------------------------------
kv_send() {
  local encoded; encoded=$(printf "%s" "$1" | b64_encode)
  local url="https://keyvalue.immanuel.co/api/KeyVal/UpdateValue/${KEYVALUE_APP_KEY}/${KEYVALUE_KEY}/${encoded}"
  local status; status=$(curl -s -o /dev/null -w "%{http_code}" -X POST -d '' "$url")
  [[ "$status" =~ ^20[01]$ ]] || { log "KeyValue POST failed ($status)"; return 1; }
  printf "ðŸ“‹ %sâœ“ Synced%s to %skeyvalue.immanuel.co%s\n" "$C_MINT" "$C_RESET" "$C_SKY" "$C_RESET" >&2
}

kv_fetch() {
  local url="https://keyvalue.immanuel.co/api/KeyVal/GetValue/${KEYVALUE_APP_KEY}/${KEYVALUE_KEY}"
  local tmp; tmp=$(mktemp)
  local status; status=$(curl -s -o "$tmp" -w "%{http_code}" "$url")
  [[ "$status" == "200" ]] || { log "KeyValue GET failed ($status)"; rm -f "$tmp"; return 1; }
  local raw; raw=$(<"$tmp"); rm -f "$tmp"
  raw=${raw//$'\r'/}; raw=${raw//$'\n'/}
  # Strip surrounding quotes if present
  [[ "${raw:0:1}${raw: -1}" == '""' ]] && raw="${raw:1:${#raw}-2}"
  [[ -n "$raw" ]] && printf "%s" "$raw" | b64_decode || printf ""
}

# --- Encryption --------------------------------------------------------------
ensure_crypto() {
  command -v openssl &>/dev/null || { log "openssl not found"; exit 1; }
  [[ -n "${COP_SECRET:-}" ]] || { log "COP_SECRET not set"; exit 1; }
}

encrypt() { ensure_crypto; openssl enc -aes-256-cbc -salt -pbkdf2 -pass env:COP_SECRET -base64; }
decrypt() { ensure_crypto; openssl enc -d -aes-256-cbc -pbkdf2 -pass env:COP_SECRET -base64; }

# --- User Confirmation -------------------------------------------------------
confirm_send() {
  local payload="$1" enc="$2" preview
  ((${#payload} > 120)) && preview="${payload:0:120}â€¦" || preview="$payload"
  
  if ((enc)); then
    printf "ðŸ“‹ %sðŸ”’ Will encrypt before upload:%s\n" "$C_LAVENDER" "$C_RESET" >&2
  else
    printf "ðŸ“‹ %sâš  Public upload:%s\n" "$C_GOLD" "$C_RESET" >&2
  fi
  printf "   %s\"%s\"%s\n" "$C_DIM" "$preview" "$C_RESET" >&2
  printf "ðŸ“‹ Proceed? [y/N] " >&2
  
  local ans=""
  [[ -r /dev/tty ]] && read -r ans </dev/tty
  [[ "$ans" =~ ^[Yy] ]] || { printf "ðŸ“‹ %sAborted%s\n" "$C_CORAL" "$C_RESET" >&2; return 1; }
}

# --- Info Display ------------------------------------------------------------
print_info() {
  show_horizon >&2
  printf "%sClipboard Info%s\n\n" "$C_GOLD" "$C_RESET" >&2
  
  # Copy commands
  printf "\n  Copy commands:\n" >&2
  for cmd in "${COPY_CMDS[@]}"; do
    local status="$C_DIMâ”€$C_RESET"
    if command -v "$cmd" &>/dev/null; then
      status="$C_MINTâœ“$C_RESET"
      case "$cmd" in
        wl-copy)    is_wayland || status="$C_GOLDâ—‹$C_RESET ${C_DIM}(no Wayland)${C_RESET}" ;;
        xclip|xsel) is_x11 || status="$C_GOLDâ—‹$C_RESET ${C_DIM}(no X11)${C_RESET}" ;;
      esac
    fi
    printf "    %-18s %s\n" "$cmd" "$status" >&2
  done
  
  # Copy command
  local copy_cmd
  copy_cmd=$(find_copy_cmd 2>/dev/null || echo "none")
  
  # Paste commands
  printf "\n  Paste commands:\n" >&2
  for cmd in "${PASTE_CMDS[@]}"; do
    local status="$C_DIMâ”€$C_RESET"
    if command -v "$cmd" &>/dev/null; then
      status="$C_MINTâœ“$C_RESET"
      case "$cmd" in
        wl-paste)   is_wayland || status="$C_GOLDâ—‹$C_RESET ${C_DIM}(no Wayland)${C_RESET}" ;;
        xclip|xsel) is_x11 || status="$C_GOLDâ—‹$C_RESET ${C_DIM}(no X11)${C_RESET}" ;;
      esac
    fi
    printf "    %-18s %s\n" "$cmd" "$status" >&2
  done
  
  local current; current=$(find_paste_cmd 2>/dev/null || echo "none")
  printf "\n  %sActive:%s copy=%s, paste=%s\n" "$C_SKY" "$C_RESET" "$copy_cmd" "$current" >&2
}

# --- Main Operations ---------------------------------------------------------
do_paste() {
  local network=$1 enc=$2 copy_local=$3 output_file="${4:-}"
  local raw out
  
  if ((network)); then
    raw=$(kv_fetch) || exit 1
    printf "ðŸ“‹ %sâœ“ Fetched%s from %skeyvalue.immanuel.co%s\n" "$C_MINT" "$C_RESET" "$C_SKY" "$C_RESET" >&2
  else
    raw=$(get_local_clipboard)
    printf "ðŸ“‹ %sâœ“ Pasted%s via %s%s%s\n" "$C_MINT" "$C_RESET" "$C_SKY" "$PASTE_USED" "$C_RESET" >&2
  fi
  
  ((enc)) && out=$(printf "%s" "$raw" | decrypt) || out="$raw"
  ((copy_local)) && printf "%s" "$out" | copy_to_clipboard
  
  if [[ -n "$output_file" ]]; then
    printf "%s" "$out" > "$output_file"
    printf "ðŸ“‹ %sâœ“ Written%s to %s%s%s (%d bytes)\n" \
      "$C_MINT" "$C_RESET" "$C_SKY" "$output_file" "$C_RESET" "${#out}" >&2
  else
    printf "%s" "$out"
  fi
}

do_copy() {
  local network=$1 enc=$2 copy_local=$3 payload="$4"
  local to_send
  
  ((enc)) && to_send=$(printf "%s" "$payload" | encrypt) || to_send="$payload"
  ((copy_local)) && printf "%s" "$to_send" | copy_to_clipboard
  
  if ((network)); then
    confirm_send "$payload" "$enc" && kv_send "$to_send"
  fi
  
  printf "ðŸ“‹ %sâœ“ Copied%s %d bytes\n" "$C_MINT" "$C_RESET" "${#payload}"
}

# --- Entry Point -------------------------------------------------------------
main() {
  local paste=0 network=0 enc=0 copy_flag=0 info_flag=0
  
  # Symlink detection
  [[ "$(basename "$0")" == "pas" ]] && paste=1
  
  # Parse options
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --help)    show_usage; exit 0 ;;
      --info)    info_flag=1 ;;
      --paste)   paste=1 ;;
      --network) network=1 ;;
      --encrypt) enc=1 ;;
      --copy)    copy_flag=1 ;;
      --)        shift; break ;;
      -*)
        for ((i=1; i<${#1}; i++)); do
          case "${1:i:1}" in
            h) show_usage; exit 0 ;;
            i) info_flag=1 ;;
            p) paste=1 ;;
            n) network=1 ;;
            e) enc=1 ;;
            c) copy_flag=1 ;;
            *) log "Unknown: -${1:i:1}"; show_usage; exit 1 ;;
          esac
        done ;;
      *) break ;;
    esac
    shift
  done
  
  # Copy-to-local logic: default on unless network mode (then explicit -c needed)
  local copy_local=$((network ? copy_flag : 1))
  
  # Marvin's sigh
  ((copy_flag && !network)) && log "${C_DIM}*sigh* -c without -nâ€¦ I was copying anyway${C_RESET}"
  
  # Info mode
  ((info_flag)) && { print_info; exit 0; }
  
  # Paste mode
  if ((paste)); then
    (($# > 1)) && { log "Only one output file allowed"; exit 1; }
    do_paste "$network" "$enc" "$copy_local" "${1:-}"
    exit 0
  fi
  
  # Copy mode
  local payload
  if [[ ! -t 0 ]]; then
    payload=$(cat)
  elif [[ $# -gt 0 ]]; then
    payload=$(cat -- "$@")
  else
    show_usage; exit 1
  fi
  
  do_copy "$network" "$enc" "$copy_local" "$payload"
}

main "$@"
