#!/usr/bin/env bash
set -euo pipefail

APP="si"

have() { command -v "$1" >/dev/null 2>&1; }

# ---------- helpers ----------
best_cat() {
  if have bat; then
    echo bat
  elif have batcat; then
    echo batcat
  else
    echo cat
  fi
}

open_in_editor() {
  local path="$1" line="${2-}"
  local editor="${EDITOR:-vim}"
  cd "$(dirname "$path")"
  if [[ -n "${line:-}" ]]; then
    "$editor" "+$line" "$(basename "$path")"
  else
    "$editor" "$(basename "$path")"
  fi
}

pipe_to_cop() {
  if have cop; then
    printf "%s" "$1" | cop
  else
    printf "%s\n" "$1"
  fi
}

# ---------- sources ----------
git_files() {
  git rev-parse --is-inside-work-tree >/dev/null 2>&1 || return
  git ls-files | awk '{ print "git\t" $0 }'
}

fd_files() {
  if have fd; then
    fd --type f --hidden --exclude .git | awk '{ print "fd\t" $0 }'
  else
    find . -type f -not -path '*/.git/*' | sed 's|^\./||' | awk '{ print "fd\t" $0 }'
  fi
}

hist_items() {
  local fish="${XDG_DATA_HOME:-$HOME/.local/share}/fish/fish_history"
  if [[ -f "$fish" ]]; then
    sed -n 's/^[[:space:]]*cmd:[[:space:]]*//p' "$fish" |
      sed 's/^"\(.*\)"$/\1/' |
      awk '{ print "history\t" $0 }'
  fi
}

env_items() {
  env | sort | awk '{ print "env\t" $0 }'
}

rg_items() {
  [[ -n "$1" ]] || return
  have rg || return
  rg -n --column --color=never -- "$1" . | awk '{ print "rg\t" $0 }'
}

# ---------- preview ----------
preview() {
  local mode="$1" q="$2" sel="$3"
  case "$mode" in
  git | fd)
    [[ -f "$sel" ]] || exit 0
    case "$(best_cat)" in
    bat) bat --color=always --line-range=:300 "$sel" ;;
    batcat) batcat --color=always --line-range=:300 "$sel" ;;
    cat) sed -n '1,200p' "$sel" ;;
    esac
    ;;
  history) printf "%s\n" "$sel" ;;
  env) printf "%s\n" "${sel#*=}" ;;
  rg)
    local file line
    file="${sel%%:*}"
    line="${sel#*:}"
    line="${line%%:*}"
    rg --color=always -n -C 3 -- "$q" "$file" || true
    ;;
  esac
}

# ---------- mode rotation ----------
modes=(git fd history env rg)

rotate_mode() {
  local cur="$1"
  for i in "${!modes[@]}"; do
    if [[ "${modes[$i]}" == "$cur" ]]; then
      echo "${modes[$(((i + 1) % ${#modes[@]}))]}"
      return
    fi
  done
  echo git
}

# ---------- main ----------
QUERY="${1-}"
MODE=git

selected="$(
  fzf \
    --query="$QUERY" \
    --delimiter=$'\t' \
    --with-nth=2 \
    --prompt="ó°±¼  " \
    --header="Ctrl-M rotate mode | Enter act | Ctrl-C exit" \
    --preview="bash -lc 'preview \"{1}\" \"$QUERY\" \"{2}\"' preview" \
    --preview-window='right,60%' \
    --bind "start:reload(git_files)" \
    --bind "ctrl-m:execute-silent(MODE=\$(rotate_mode \"$MODE\"))+reload(
      case \"$MODE\" in
        git) git_files ;;
        fd) fd_files ;;
        history) hist_items ;;
        env) env_items ;;
        rg) rg_items \"$QUERY\" ;;
      esac
    )"
)" || exit 0

IFS=$'\t' read -r mode payload <<<"$selected"

case "$mode" in
git | fd) open_in_editor "$payload" ;;
history | env) pipe_to_cop "$payload" ;;
rg)
  file="${payload%%:*}"
  line="${payload#*:}"
  line="${line%%:*}"
  open_in_editor "$file" "$line"
  ;;
esac
